<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Officer Task Status Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #f4f7f6; color: #333; }
        h1 { color: #2c3e50; text-align: center; }
        h3 { border-bottom: 2px solid #0d6efd; padding-bottom: 5px; color: #0d6efd; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #dee2e6; padding: 12px; font-size: 14px; text-align: center; }
        th { background: #343a40; color: white; text-transform: uppercase; letter-spacing: 1px; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        .status-incomplete { color: #dc3545; font-weight: bold; }
        .status-complete { color: #198754; font-weight: bold; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        #loading { text-align: center; font-weight: bold; color: #0d6efd; padding: 20px; font-size: 1.2em; }
        .info { margin-top: 20px; padding: 15px; background: #fff3cd; border-left: 5px solid #ffc107; border-radius: 4px; }
    </style>
</head>
<body>

<h1>üìä Master Dashboard ‚Äì Officer Task Status</h1>

<div id="loading">‚è≥ Fetching latest data from all Officer Sheets...</div>

<div class="grid">
    <div>
        <h3>üìã Weekly Status Summary</h3>
        <table id="weeklyTable">
            </table>
    </div>
    <div>
        <h3>‚≠ê Star-Mark Summary</h3>
        <table id="starTable"></table>
    </div>
</div>

<h3>‚öñÔ∏è Upcoming Court Cases</h3>
<table id="courtTable"></table>

<div class="info">
    <strong>Logic:</strong> If any single task in an officer's sheet is marked <em>Incomplete</em> or <em>Pending</em>, the <strong>Overall Status</strong> is marked as <strong>Incomplete</strong>.
</div>

<script>
/* --------------------------------------------------
CONFIG: ALL OFFICERS ADDED
-------------------------------------------------- */
const OFFICER_SHEETS = {
    "ADC G": "174981592",
    "ADC D": "537074213",
    "ADC (UD)": "846764018",
    "ADC K": "1476602908",
    "ADC J": "18822170",
    "ACG": "1291568180",
    "CMFO": "1227420096",
    "SDM East": "33416154",
    "SDM West": "52989510",
    "SDM Raikot": "1833732603",
    "SDM Samrala": "190794459",
    "SDM Khanna": "2054147547",
    "SDM Jargon": "278920499",
    "SDM Payal": "778489712",
    "DRO": "501565659",
    "RTA": "1563439729"
};

const BASE_SID = "1jspebqSTXgEtYyxYAE47_uRn6RQKFlHQhneuQoGiCok";
const STAR_URL = "https://docs.google.com/spreadsheets/d/14-idXJHzHKCUQxxaqGZi-6S0G20gvPUhK4G16ci2FwI/export?format=csv&gid=213021534";
const COURT_URL = "https://docs.google.com/spreadsheets/d/1VUnD7ySFzIkeZlaq8E5XG8r2xXcos6lhIt62QZEeHKs/export?format=csv&gid=0";

/* --------------------------------------------------
HELPERS
-------------------------------------------------- */
function csvToArray(csv) {
    // Simple CSV parser that handles basic commas
    return csv.trim().split("\n").map(r => r.split(","));
}

function renderTable(id, headers, rows) {
    let html = "<thead><tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr></thead><tbody>";
    rows.forEach(r => {
        html += "<tr>" + r.map((c, index) => {
            let className = "";
            if (c === "Incomplete") className = "class='status-incomplete'";
            if (c === "Complete") className = "class='status-complete'";
            return `<td ${className}>${c}</td>`;
        }).join("") + "</tr>";
    });
    html += "</tbody>";
    document.getElementById(id).innerHTML = html;
}

/* --------------------------------------------------
MAIN LOGIC: WEEKLY STATUS
-------------------------------------------------- */
async function loadWeekly() {
    const rows = [];

    for (const officer in OFFICER_SHEETS) {
        try {
            const gid = OFFICER_SHEETS[officer];
            const url = `https://docs.google.com/spreadsheets/d/${BASE_SID}/export?format=csv&gid=${gid}`;
            const response = await fetch(url);
            const data = csvToArray(await response.text());

            // 1. Find the "Status" column (Scanning top 10 rows)
            let statusCol = -1;
            for (let i = 0; i < 10; i++) {
                if (data[i]) {
                    const foundIndex = data[i].findIndex(h => h.toLowerCase().trim() === "status");
                    if (foundIndex !== -1) {
                        statusCol = foundIndex;
                        break;
                    }
                }
            }

            let incompleteCount = 0;
            let completeCount = 0;

            // 2. Process rows (Skipping headers)
            // We assume data starts after row 3 based on your "Sr. No" structure
            data.slice(3).forEach(r => {
                if (statusCol === -1 || !r[statusCol]) return;
                
                const val = r[statusCol].toLowerCase().trim();
                if (val.includes("incomplete") || val.includes("pending")) {
                    incompleteCount++;
                } else if (val.includes("complete")) {
                    completeCount++;
                }
            });

            // 3. Determine Overall Status
            // Logic: If even 1 is incomplete, overall is incomplete.
            const overallStatus = incompleteCount > 0 ? "Incomplete" : (completeCount > 0 ? "Complete" : "No Tasks");

            rows.push([officer, overallStatus, incompleteCount, completeCount]);

        } catch (e) {
            console.error(`Error loading ${officer}:`, e);
            rows.push([officer, "Error Loading", "-", "-"]);
        }
    }

    renderTable("weeklyTable", 
        ["Officer Name", "Overall Status", "No. of Tasks Incomplete", "No. of Tasks Completed"], 
        rows
    );
}

// ... (Star and Court logic remain similar but with updated error handling) ...
async function loadStar() {
    try {
        const response = await fetch(STAR_URL);
        const data = csvToArray(await response.text());
        const headers = data[0];
        const rows = data.slice(1);
        const map = {};

        const officerIdx = headers.indexOf("Marked to Officer");
        const statusIdx = headers.indexOf("Status");

        rows.forEach(r => {
            const officer = r[officerIdx];
            if (!officer) return;
            const status = (r[statusIdx] || "").toLowerCase().trim();
            if (!map[officer]) map[officer] = {completed:0, pending:0};
            if (status === "completed") map[officer].completed++;
            else map[officer].pending++;
        });

        const tableRows = Object.entries(map).map(([k,v]) => [k, v.completed, v.pending]);
        renderTable("starTable", ["Marked to Officer", "Completed", "Pending Tasks"], tableRows);
    } catch (e) { console.error("Star loading error", e); }
}

async function loadCourt() {
    try {
        const response = await fetch(COURT_URL);
        const data = csvToArray(await response.text());
        const rows = data.slice(1).slice(0, 10); // Show top 10 upcoming
        const filtered = rows.map(r => [r[2], r[5], r[6]]); // Adjusting indices for Name, Date, Court
        renderTable("courtTable", ["Officer", "Date", "Court Name"], filtered);
    } catch (e) { console.error("Court loading error", e); }
}

// Initializing
Promise.all([loadWeekly(), loadStar(), loadCourt()]).then(() => {
    document.getElementById("loading").style.display = "none";
});
</script>

</body>
</html>
