<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Master Officer Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #f4f7f6; color: #333; }
        h1 { color: #2c3e50; text-align: center; }
        .dashboard-container { display: flex; flex-direction: column; gap: 30px; }
        .top-row { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #dee2e6; padding: 10px; text-align: center; font-size: 13px; }
        th { background: #343a40; color: white; }
        .status-incomplete { background-color: #ffdce0; color: #d93025; font-weight: bold; }
        .status-complete { background-color: #e6f4ea; color: #1e8e3e; font-weight: bold; }
        #loading { text-align: center; font-size: 1.2em; color: #0d6efd; padding: 50px; }
        .chart-container { height: 400px; width: 100%; }
    </style>
</head>
<body>

<h1>üìä Master Dashboard ‚Äì All Officers & SDMs</h1>

<div id="loading">‚è≥ Fetching live data from all sheets...</div>

<div id="mainContent" class="dashboard-container" style="display:none;">
    
    <div class="card">
        <h3>üìà Task Performance Graph</h3>
        <div class="chart-container">
            <canvas id="taskChart"></canvas>
        </div>
    </div>

    <div class="top-row">
        <div class="card">
            <h3>üìã Detailed Status Table</h3>
            <table id="weeklyTable"></table>
        </div>

        <div class="card">
            <h3>‚≠ê Star-Mark Summary</h3>
            <table id="starTable"></table>
        </div>
    </div>
</div>

<script>
/* --------------------------------------------------
CONFIG: FULL OFFICER LIST
-------------------------------------------------- */
const BASE_SID = "1jspebqSTXgEtYyxYAE47_uRn6RQKFlHQhneuQoGiCok";
const OFFICER_SHEETS = {
    "ADC G": "174981592", "ADC D": "537074213", "ADC (UD)": "846764018",
    "ADC K": "1476602908", "ADC J": "18822170", "ACG": "1291568180",
    "CMFO": "1227420096", "SDM East": "33416154", "SDM West": "52989510",
    "SDM Raikot": "1833732603", "SDM Samrala": "190794459", "SDM Khanna": "2054147547",
    "SDM Jagraon": "278920499", "SDM Payal": "778489712", "DRO": "501565659", "RTA": "1563439729"
};

/* --------------------------------------------------
DATA PROCESSING
-------------------------------------------------- */
async function loadData() {
    const tableData = [];
    const labels = [];
    const incompleteData = [];
    const completeData = [];

    for (const officer in OFFICER_SHEETS) {
        try {
            const gid = OFFICER_SHEETS[officer];
            const url = `https://docs.google.com/spreadsheets/d/${BASE_SID}/export?format=csv&gid=${gid}`;
            const response = await fetch(url);
            const text = await response.text();
            const rows = text.split("\n").map(r => r.split(","));

            // Auto-detect "Status" column
            let statusCol = -1;
            for (let i = 0; i < 10; i++) {
                if (rows[i]) {
                    const idx = rows[i].findIndex(c => c.toLowerCase().trim().includes("status"));
                    if (idx !== -1) { statusCol = idx; break; }
                }
            }

            let inc = 0, com = 0;
            rows.slice(2).forEach(r => {
                const val = (r[statusCol] || "").toLowerCase().trim();
                if (val.includes("incomplete") || val.includes("pending")) inc++;
                else if (val.includes("complete")) com++;
            });

            const overall = inc > 0 ? "Incomplete" : (com > 0 ? "Complete" : "No Tasks");
            
            tableData.push([officer, overall, inc, com]);
            labels.push(officer);
            incompleteData.push(inc);
            completeData.push(com);

        } catch (e) {
            console.error(e);
            tableData.push([officer, "Error", 0, 0]);
        }
    }

    renderUI(tableData, labels, incompleteData, completeData);
}

function renderUI(tableData, labels, incompleteData, completeData) {
    // 1. Render Table
    let html = `<tr><th>Officer Name</th><th>Overall Status</th><th>Incomplete</th><th>Completed</th></tr>`;
    tableData.forEach(row => {
        const statusClass = row[1] === "Incomplete" ? "status-incomplete" : (row[1] === "Complete" ? "status-complete" : "");
        html += `<tr><td>${row[0]}</td><td class="${statusClass}">${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td></tr>`;
    });
    document.getElementById("weeklyTable").innerHTML = html;

    // 2. Render Graph
    const ctx = document.getElementById('taskChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label: 'Incomplete Tasks', data: incompleteData, backgroundColor: '#d93025' },
                { label: 'Completed Tasks', data: completeData, backgroundColor: '#1e8e3e' }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });

    document.getElementById("loading").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
}

loadData();
</script>
</body>
</html>
