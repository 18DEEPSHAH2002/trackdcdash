<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Officer Task Dashboard â€“ Ludhiana</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    background: linear-gradient(135deg,#667eea,#764ba2);
    padding:20px;
}
.glass {
    background: rgba(255,255,255,.95);
    border-radius:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.15);
}
.badge-ok { background:#10b981; color:#fff; padding:4px 10px; border-radius:6px; font-size:12px; }
.badge-pending { background:#ef4444; color:#fff; padding:4px 10px; border-radius:6px; font-size:12px; }
</style>
</head>

<body>

<div class="max-w-7xl mx-auto space-y-6">

<h1 class="text-white text-3xl font-extrabold">ðŸ“‹ Ludhiana Administrative Task Tracker</h1>

<!-- KPI -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div class="glass p-4 text-center">
<p class="text-gray-500 text-sm">Active Officers</p>
<p id="totalOfficers" class="text-3xl font-extrabold">-</p>
</div>
<div class="glass p-4 text-center">
<p class="text-gray-500 text-sm">Total Pending</p>
<p id="totalPending" class="text-3xl font-extrabold">-</p>
</div>
<div class="glass p-4 text-center">
<p class="text-gray-500 text-sm">Completed (7 Days)</p>
<p id="totalCompletedWeek" class="text-3xl font-extrabold">-</p>
</div>
</div>

<!-- Summary Table -->
<div class="glass p-6">
<h2 class="font-extrabold text-lg mb-4">Officer Summary (Spreadsheet 2)</h2>
<table class="w-full border">
<thead class="bg-indigo-600 text-white text-sm">
<tr>
<th class="p-2 text-left">Marked To</th>
<th class="p-2 text-center">Completed (7d)</th>
<th class="p-2 text-center">Pending</th>
</tr>
</thead>
<tbody id="summaryBody"></tbody>
</table>
</div>

<!-- Main Table -->
<div class="glass p-6">
<h2 class="font-extrabold text-lg mb-4">Division Wise Status</h2>
<table class="w-full border">
<thead class="bg-indigo-600 text-white text-sm">
<tr>
<th class="p-2 text-left">Officer</th>
<th class="p-2 text-center">Pending</th>
<th class="p-2 text-center">Status</th>
</tr>
</thead>
<tbody id="mainBody"></tbody>
</table>
</div>

<canvas id="chart" height="120"></canvas>

</div>

<script>
const MAIN_SHEET_ID = "1jspebqSTXgEtYyxYAE47_uRn6RQKFlHQhneuQoGiCok";
const SUMMARY_SHEET_ID = "14-idXJHzHKCUQxxaqGZi-6S0G20gvPUhK4G16ci2FwI";
const SUMMARY_GID = "213021534";

const officers = [
 {name:"ADC G",gid:"174981592"},
 {name:"ADC D",gid:"537074213"},
 {name:"ADC UD",gid:"846764018"},
 {name:"ADC K",gid:"1476602908"},
 {name:"ADC J",gid:"18822170"},
 {name:"SDM East",gid:"33416154"},
 {name:"SDM West",gid:"52989510"},
 {name:"DRO",gid:"501565659"},
 {name:"RTA",gid:"1563439729"}
];

async function fetchCSV(id,gid){
 const r = await fetch(`https://docs.google.com/spreadsheets/d/${id}/export?format=csv&gid=${gid}&t=${Date.now()}`);
 const t = await r.text();
 return t.split("\n").map(r=>r.split(","));
}

async function processSummary(){
 const data = await fetchCSV(SUMMARY_SHEET_ID,SUMMARY_GID);
 const header = data[0].map(h=>h.toLowerCase());
 const rows = data.slice(1);

 const offIdx = header.findIndex(h=>h.includes("officer")||h.includes("marked"));
 const statIdx = header.findIndex(h=>h.includes("status"));
 const dateIdx = header.findIndex(h=>h.includes("date"));

 const sevenDaysAgo = new Date();
 sevenDaysAgo.setDate(sevenDaysAgo.getDate()-7);

 const map = {};

 rows.forEach(r=>{
   const name = (r[offIdx]||"").trim();
   if(!name) return;

   const status = (r[statIdx]||"").toLowerCase().trim();
   const date = dateIdx>-1 ? new Date(r[dateIdx]) : null;

   if(!map[name]) map[name]={completed:0,pending:0};

   // âœ… STRICT STATUS LOGIC
   if(["completed","done","yes"].includes(status)){
       if(!date || isNaN(date) || date>=sevenDaysAgo){
           map[name].completed++;
       }
   }
   else if(["pending","in progress","in-progress","ongoing"].includes(status)){
       map[name].pending++;
   }
   // everything else ignored
 });

 return Object.entries(map).map(([name,v])=>({name,...v}));
}

async function processOfficer(gid){
 const data = await fetchCSV(MAIN_SHEET_ID,gid);
 const header = data[0].map(h=>h.toLowerCase());
 const rows = data.slice(1);
 const sIdx = header.findIndex(h=>h.includes("status"));
 let p=0;
 rows.forEach(r=>{
   const s=(r[sIdx]||"").toLowerCase().trim();
   if(["pending","in progress","in-progress","ongoing"].includes(s)) p++;
 });
 return p;
}

async function load(){
 const summary = await processSummary();
 const main = [];

 for(const o of officers){
   const p = await processOfficer(o.gid);
   main.push({name:o.name,pending:p});
 }

 document.getElementById("totalOfficers").innerText = main.length;
 document.getElementById("totalPending").innerText = main.reduce((a,b)=>a+b.pending,0);
 document.getElementById("totalCompletedWeek").innerText = summary.reduce((a,b)=>a+b.completed,0);

 document.getElementById("summaryBody").innerHTML = summary.map(s=>`
 <tr>
 <td class="p-2 font-bold">${s.name}</td>
 <td class="p-2 text-center">${s.completed}</td>
 <td class="p-2 text-center">${s.pending}</td>
 </tr>`).join("");

 document.getElementById("mainBody").innerHTML = main.map(m=>`
 <tr>
 <td class="p-2 font-bold">${m.name}</td>
 <td class="p-2 text-center">${m.pending}</td>
 <td class="p-2 text-center">
   ${m.pending>0 ? '<span class="badge-pending">Action</span>' : '<span class="badge-ok">Clear</span>'}
 </td>
 </tr>`).join("");

 new Chart(document.getElementById("chart"),{
   type:"bar",
   data:{labels:main.map(m=>m.name),
   datasets:[{data:main.map(m=>m.pending)}]},
   options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
 });
}

load();
</script>

</body>
</html>
